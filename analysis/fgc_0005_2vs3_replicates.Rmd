---
title: 'FGC_0005: HCT116 - 2 vs 3 replicates'
author: "Alex Kalinka"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    depth: 3
    highlight: tango
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
---

# Setup

```{r,echo=F}
options(warn=-1)

suppressMessages(library(knitr))
suppressMessages(library(tidyr))
suppressMessages(library(magrittr))
suppressMessages(library(ggplot2))
suppressMessages(library(dplyr))
suppressMessages(library(fgcQC))
suppressMessages(library(GGally))
suppressMessages(library(locfdr))
suppressMessages(library(perept))

filter <- dplyr::filter
select <- dplyr::select
rename <- dplyr::rename
mutate <- dplyr::mutate



mle_desir_0.8.3reps <- readRDS(file="../data/mle_depleted_desir_thresh_0.8.rds")
fdr <- readRDS(file = "../data/fdr_2vs3reps.rds")
mle_desir_0.8.2reps_1 <- readRDS(file="../data/mle_depleted_desir_thresh_0.8.2reps-1.rds")
mle_desir_0.8.2reps_2 <- readRDS(file="../data/mle_depleted_desir_thresh_0.8.2reps-2.rds")
mle_desir_0.8.2reps_3 <- readRDS(file="../data/mle_depleted_desir_thresh_0.8.2reps-3.rds")

# Shared hits.
hits.shared <- read.csv("../data/fgc_0005_depletion_hit_table.csv", stringsAsFactors = F) %>%
  filter(hit_type == "Shared")


# Data kept locally.
mageck_files <- list.files("~/data/az_cruk/cdc7", 
                           pattern = "Treatment_vs_Control.gene_summary.txt", recursive = T, full.names = T)

desir_files <- list.files("~/data/az_cruk/cdc7", 
                          pattern = "DesirabilityGeneRanking.tsv",recursive = T, full.names = T)

read_gene_summ <- function(files, type = "mageck", filter_hct = T){
  ret <- NULL
  for(file in files){
    cell_line <- gsub("^.*?Comp-(\\S+?)\\/.*$","\\1",file)
    if(filter_hct){
      if(!grepl("HCT116",cell_line))
        next
    }
    if(type == "mageck"){
      td <- read.table(file, header=T, stringsAsFactors = F) %>%
        select(id, neg.score, neg.p.value, neg.fdr, neg.rank, neg.lfc, pos.score, pos.p.value, pos.fdr, pos.rank, pos.lfc) %>%
        rename(gene = id)
    }else{
      td <- read.delim(file, header=T, stringsAsFactors = T) %>%
        select(gene, TvCCvP_PositiveDesi, TvCCvP_NegativeDesi, TvC_negpval, TvC_pospval, TvC_LFC)
    }
    ret <- rbind(ret, data.frame(cell_line = cell_line, td), stringsAsFactors=F)
  }
  return(ret)
}


jaccard_index <- function(genes, data_1, data_2){
  jacc_num <- length(intersect(genes[data_1], genes[data_2]))
  jacc_denom <- length(union(genes[data_1], genes[data_2]))
  return(jacc_num/jacc_denom)
}


mh <- read_gene_summ(mageck_files)
dh <- read_gene_summ(desir_files, type = "desir")
dh.all <- read_gene_summ(desir_files, type = "desir", filter_hct = F)

```


# Hit counts

We do not see more candidate hits for the 3 replicate case.

```{r}
hit_comp <- mh %>%
  rowwise() %>%
  mutate(hit_fdr_5pct = (neg.fdr < 0.05 || pos.fdr < 0.05),
         hit_fdr_10pct = (neg.fdr < 0.1 || pos.fdr < 0.1)) %>%
  ungroup

hit_comp %>%
  group_by(cell_line) %>%
  summarise(Num_hits_fdr_5pct = sum(hit_fdr_5pct),
            Num_hits_fdr_10pct = sum(hit_fdr_10pct)) %>%
  ungroup %>%
  kable()

```

# Hit comparison

## Singleton similarities

The 3 replicate case shares more hits with the 2 replicate cases on the whole than they do with each other.

```{r}
ji <- pivot_wider(hit_comp, id_cols = c(gene,cell_line), 
                  names_from = cell_line, values_from = hit_fdr_10pct)
jd <- c(jaccard_index(ji$gene, ji$HCT116, ji$HCT116_2replicates_combn1),
        jaccard_index(ji$gene, ji$HCT116, ji$HCT116_2replicates_combn2),
        jaccard_index(ji$gene, ji$HCT116, ji$HCT116_2replicates_combn3),
        jaccard_index(ji$gene, ji$HCT116_2replicates_combn1, ji$HCT116_2replicates_combn2),
        jaccard_index(ji$gene, ji$HCT116_2replicates_combn1, ji$HCT116_2replicates_combn3),
        jaccard_index(ji$gene, ji$HCT116_2replicates_combn2, ji$HCT116_2replicates_combn3))
jacc.mat <- matrix(c(1,jd[1:3],
                         jd[1],1,jd[4:5],
                         jd[c(2,4)],1,jd[6],
                         jd[c(3,5,4)],1), 4, 4, byrow = T)
colnames(jacc.mat) <- rownames(jacc.mat) <- c("HCT116_3reps","HCT116_2reps-1","HCT116_2reps-2","HCT116_2reps-3")

ggcorr(jacc.mat, label = T, label_round = 3, cor_matrix = jacc.mat, limits=c(0.25,0.6),
       midpoint = 0.4) +
  labs(title = "HCT116 Hit similarities:",
       subtitle =  "Jaccard Index")

```


## Log FC variance

There is lower variance in the logFC distribution when we use 3 replicates vs 2:

```{r}
mh %>%
  group_by(cell_line) %>%
  summarise(lfc.sd=sd(neg.lfc),lfc.mad=mad(neg.lfc)) %>%
  kable()

```

## Shared hit comparison: MLE of Desirability Thresholds

* FDR rises faster for 2 reps vs 3 reps.
* More shared hits at Desirability Threshold of 0.8 for 3 reps vs 2 reps.

```{r}
# Put data into format needed by 'MLE.perept'.
prep_4_mle <- function(data, desir_thresh, dcol_name = "TvCCvP_NegativeDesi"){
  dcol <- sym(dcol_name)
  data %<>%
      mutate(hit = !!dcol >= desir_thresh) %>%
      tidyr::pivot_wider(id_cols = c(cell_line, gene), names_from = cell_line, values_from = hit) %>%
      dplyr::rowwise() %>%
      mutate(total = sum(c(HCT116, `HT-29`, RKO, SW480))) %>%
      dplyr::ungroup() %>%
      filter(!is.na(total) & gene != "Control")
  return(data)
}

# Find desirability threshold that corresponds to FDR of X%.
fix_FDR.desir <- function(data, start_desir = 0.9, stop_desir = NULL, fdr_thresh = 0.1, type = "negative", step_size = 0.1){
  if(type == "negative"){
    data %<>%
      select(cell_line, gene, TvCCvP_NegativeDesi)
    dcol <- "TvCCvP_NegativeDesi"
  }else{
    data %<>%
      select(cell_line, gene, TvCCvP_PositiveDesi)
    dcol <- "TvCCvP_PositiveDesi"
  }
  desir_thresh <- start_desir
  finish <- FALSE
  track_perf <- NULL
  while(!finish){
    cat("Desirability Threshold:",desir_thresh,"\n")
    td <- prep_4_mle(data, desir_thresh, dcol_name = dcol)
    mle <- MLE.perept(as.data.frame(td))
    # Estimate of global FDR.
    num_TP <- mle$prevalence$theta_1*nrow(td)
    num_TN <- nrow(td)-num_TP
    num_FP <- mle$performance$p10*num_TN
    FDR <- num_FP/(num_FP+num_TP)
    # Estimate of FDR after excluding singletons.
    if(length(which(td$total>=2))==0){
      # No shared hits.
      FDR.comm <- 0
      prob_pos_2 <- 0
    }else{
      prob_two_false <- 1-mle$delta$delta_pos[which(td$total==2)[1]]
      prob_three_false <- 1-mle$delta$delta_pos[which(td$total==3)[1]]
      num_two_false <- round(length(which(td$total==2))*prob_two_false)
      num_three_false <- round(length(which(td$total==3))*prob_three_false)
      FDR.comm <- (num_two_false + num_three_false)/(length(which(td$total>=2)))
      prob_pos_2 <- mle$delta$delta_pos[which(td$total==2)[1]]
    }
    track_perf <- rbind(track_perf, data.frame(Desir_threshold = desir_thresh,
                                               FPR = mle$performance$p10,
                                               FDR.global = FDR,
                                               FDR.common = FDR.comm,
                                               Sensitivity = mle$performance$p11,
                                               Prevalence = round(mle$prevalence$theta_1*nrow(td)),
                                               Prob_pos.two_shared_hits = prob_pos_2,
                                               Number_singletons = length(which(td$total==1)),
                                               Number_common_hits = length(which(td$total>=2))))
    if(!is.null(stop_desir)){
      if(desir_thresh <= stop_desir){
        finish <- TRUE
        ret <- td %>%
        mutate(probability_hit = mle$delta$delta_pos)
      }
    }
    if(FDR.comm >= fdr_thresh){
      finish <- TRUE
      ret <- td %>%
        mutate(probability_hit = mle$delta$delta_pos)
    }else{
      desir_thresh <- desir_thresh - step_size
    }
  }
  return(list(data = ret, perf = track_perf))
}

```


```{r, eval=F}
fdr.desir.3reps <- fix_FDR.desir(dh.all %>% 
                             filter(cell_line %in% c("HCT116","HT-29","RKO","SW480")))
fdr.desir.2reps_1 <- fix_FDR.desir(dh.all %>% 
                             filter(cell_line %in% c("HCT116_2replicates_combn1","HT-29","RKO","SW480")) %>%
                               mutate(cell_line = ifelse(cell_line == "HCT116_2replicates_combn1","HCT116",cell_line)))
fdr.desir.2reps_2 <- fix_FDR.desir(dh.all %>% 
                             filter(cell_line %in% c("HCT116_2replicates_combn2","HT-29","RKO","SW480")) %>%
                               mutate(cell_line = ifelse(cell_line == "HCT116_2replicates_combn2","HCT116",cell_line)))
fdr.desir.2reps_3 <- fix_FDR.desir(dh.all %>% 
                             filter(cell_line %in% c("HCT116_2replicates_combn3","HT-29","RKO","SW480")) %>%
                               mutate(cell_line = ifelse(cell_line == "HCT116_2replicates_combn3","HCT116",cell_line)))

fdr <- rbind(fdr.desir.3reps$perf %>% mutate(type = "HCT116_3reps"),
             fdr.desir.2reps_1$perf %>% mutate(type = "HCT116_2reps-1"),
             fdr.desir.2reps_2$perf %>% mutate(type = "HCT116_2reps-2"),
             fdr.desir.2reps_3$perf %>% mutate(type = "HCT116_2reps-3"))

mle_desir_0.8.3reps <- MLE.perept(as.data.frame(prep_4_mle(dh.all %>%
                                                             filter(cell_line %in% c("HCT116","HT-29","RKO","SW480")),
                                                           0.8)))
mle_desir_0.8.2reps_1 <- MLE.perept(as.data.frame(prep_4_mle(dh.all %>%
                                                             filter(cell_line %in% c("HCT116_2replicates_combn1","HT-29","RKO","SW480")) %>%
                               mutate(cell_line = ifelse(cell_line == "HCT116_2replicates_combn1","HCT116",cell_line)),
                                                           0.8)))
mle_desir_0.8.2reps_2 <- MLE.perept(as.data.frame(prep_4_mle(dh.all %>%
                                                             filter(cell_line %in% c("HCT116_2replicates_combn2","HT-29","RKO","SW480")) %>%
                               mutate(cell_line = ifelse(cell_line == "HCT116_2replicates_combn2","HCT116",cell_line)),
                                                           0.8)))
mle_desir_0.8.2reps_3 <- MLE.perept(as.data.frame(prep_4_mle(dh.all %>%
                                                             filter(cell_line %in% c("HCT116_2replicates_combn3","HT-29","RKO","SW480")) %>%
                               mutate(cell_line = ifelse(cell_line == "HCT116_2replicates_combn3","HCT116",cell_line)),
                                                           0.8)))

```


```{r}
fdr %>%
  ggplot(aes(Desir_threshold, FDR.common, color = type)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0.1, linetype="dashed") +
  ggtitle("Desirability Threshold at FDR 10%: 2 vs 3 replicates")

```


```{r}
# Comparison at Desirability Threshold of 0.8
cand.3reps <-  prep_4_mle(dh.all %>%
                            filter(cell_line %in% c("HCT116","HT-29","RKO","SW480")), 0.8) %>%
  mutate(probability_hit = mle_desir_0.8.3reps$delta$delta_pos,
         gene_hit = probability_hit > 0.5)

cand.2reps_1 <-  prep_4_mle(dh.all %>%
                            filter(cell_line %in% c("HCT116_2replicates_combn1","HT-29","RKO","SW480")) %>%
                            mutate(cell_line = ifelse(cell_line == "HCT116_2replicates_combn1","HCT116",cell_line)), 0.8) %>%
  mutate(probability_hit = mle_desir_0.8.2reps_1$delta$delta_pos,
         gene_hit = probability_hit > 0.5)

cand.2reps_2 <-  prep_4_mle(dh.all %>%
                            filter(cell_line %in% c("HCT116_2replicates_combn2","HT-29","RKO","SW480")) %>%
                            mutate(cell_line = ifelse(cell_line == "HCT116_2replicates_combn2","HCT116",cell_line)), 0.8) %>%
  mutate(probability_hit = mle_desir_0.8.2reps_2$delta$delta_pos,
         gene_hit = probability_hit > 0.5)

cand.2reps_3 <-  prep_4_mle(dh.all %>%
                            filter(cell_line %in% c("HCT116_2replicates_combn3","HT-29","RKO","SW480")) %>%
                            mutate(cell_line = ifelse(cell_line == "HCT116_2replicates_combn3","HCT116",cell_line)), 0.8) %>%
  mutate(probability_hit = mle_desir_0.8.2reps_3$delta$delta_pos,
         gene_hit = probability_hit > 0.5)


# Shared hit comparison.
data.frame(type = c("HCT116_3reps","HCT116_2reps-1","HCT116_2reps-2","HCT116_2reps-3"),
                   Number_shared_hits = c(sum(cand.3reps$gene_hit),
                                          sum(cand.2reps_1$gene_hit),
                                          sum(cand.2reps_2$gene_hit),
                                          sum(cand.2reps_3$gene_hit))) %>%
  ggplot(aes(type, Number_shared_hits, fill=type)) +
  geom_bar(stat = "identity") +
  ggtitle("Number of shared hits at Desirability Threshold of 0.8")


```



# Power estimates: `locfdr`

Using Efron's local FDR approach (Efron 2007) and the accompanying R package `locfdr` to estimate the statistical power of 3 vs 2 replicates at an FDR of 10%. A summary statistic is used for each gene - below, we use p-values and log fold changes.

## P-values

```{r}
pv.3_reps <- mh$neg.p.value[mh$cell_line=="HCT116"]
pv.3_reps[pv.3_reps==1] <- 0.999
lf_3reps <- locfdr(qnorm(pv.3_reps), plot=0)
pv.2_reps.1 <- mh$neg.p.value[mh$cell_line=="HCT116_2replicates_combn1"]
pv.2_reps.1[pv.2_reps.1==1] <- 0.999
lf_2reps.1 <- locfdr(qnorm(pv.2_reps.1), plot=0)
pv.2_reps.2 <- mh$neg.p.value[mh$cell_line=="HCT116_2replicates_combn2"]
pv.2_reps.2[pv.2_reps.2==1] <- 0.999
lf_2reps.2 <- locfdr(qnorm(pv.2_reps.2), plot=0)
pv.2_reps.3 <- mh$neg.p.value[mh$cell_line=="HCT116_2replicates_combn3"]
pv.2_reps.3[pv.2_reps.3==1] <- 0.999
lf_2reps.3 <- locfdr(qnorm(pv.2_reps.3), plot=0)

roc <- rbind(as.data.frame(lf_3reps$cdf1) %>%
  rename(FDR = p1, Sensitivity = V2) %>%
  mutate(Type = "3_reps"),
  as.data.frame(lf_2reps.1$cdf1) %>%
  rename(FDR = p1, Sensitivity = V2) %>%
  mutate(Type = "2_reps.1"),
  as.data.frame(lf_2reps.2$cdf1) %>%
  rename(FDR = p1, Sensitivity = V2) %>%
  mutate(Type = "2_reps.2"),
  as.data.frame(lf_2reps.3$cdf1) %>%
  rename(FDR = p1, Sensitivity = V2) %>%
  mutate(Type = "2_reps.3"))


roc %>%
  ggplot(aes(FDR, Sensitivity, color = Type)) +
  geom_line() +
  ylim(0,1) +
  geom_vline(xintercept = 0.1, lintype = "dashed") +
  geom_abline(linetype = "dashed") +
  ggtitle("HCT116: replicate power comparison - p-values")

```

## Log-fold changes

```{r}
lf_3reps <- locfdr(scale(mh$neg.lfc[mh$cell_line=="HCT116"]), df = 15, plot=0)
lf_2reps.1 <- locfdr(scale(mh$neg.lfc[mh$cell_line=="HCT116_2replicates_combn1"]), df = 15, plot=0)
lf_2reps.2 <- locfdr(scale(mh$neg.lfc[mh$cell_line=="HCT116_2replicates_combn2"]), df = 15, plot=0)
lf_2reps.3 <- locfdr(scale(mh$neg.lfc[mh$cell_line=="HCT116_2replicates_combn3"]), df = 15, plot=0)

roc <- rbind(as.data.frame(lf_3reps$cdf1) %>%
  rename(FDR = p1, Sensitivity = V2) %>%
  mutate(Type = "3_reps"),
  as.data.frame(lf_2reps.1$cdf1) %>%
  rename(FDR = p1, Sensitivity = V2) %>%
  mutate(Type = "2_reps.1"),
  as.data.frame(lf_2reps.2$cdf1) %>%
  rename(FDR = p1, Sensitivity = V2) %>%
  mutate(Type = "2_reps.2"),
  as.data.frame(lf_2reps.3$cdf1) %>%
  rename(FDR = p1, Sensitivity = V2) %>%
  mutate(Type = "2_reps.3"))


roc %>%
  ggplot(aes(FDR, Sensitivity, color = Type)) +
  geom_line() +
  ylim(0,1) +
  geom_vline(xintercept = 0.1, lintype = "dashed") +
  geom_abline(linetype = "dashed") +
  ggtitle("HCT116: replicate power comparison - logFC")

```

# Conclusions

* 3 reps not likely to give more hits when we have low power.
* Lower variance of logFC with 3 reps.
* Hits at 3 reps are likely to be better candidates.
* Shared hits across multiple cell lines likely to be higher for 3 reps.

# References

Efron, B. 2007. Size, power and false discovery rates. Annals of Statistics 35: 1351-1377.

