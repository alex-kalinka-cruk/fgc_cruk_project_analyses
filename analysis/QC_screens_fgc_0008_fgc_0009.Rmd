---
title: 'QC screen (HT-29 essentiality) analysis: FGC_0008 and FGC_0009'
author: "Alex Kalinka"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    depth: 3
    highlight: tango
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
---

# Setup

```{r,echo=F}
options(warn=-1)

suppressMessages(library(knitr))
suppressMessages(library(tidyr))
suppressMessages(library(magrittr))
suppressMessages(library(readr))
suppressMessages(library(ggplot2))
suppressMessages(library(dplyr))
suppressMessages(library(crispRutils))

select <- dplyr::select
filter <- dplyr::filter

load("../data/ess.genes.rda")
genes.mod_fitn <- readRDS(file="~/data/az_cruk/depmap/depmap_lfc_modfitn.rds")

data_base_path <- "~/data/az_cruk"

cleanr_lfc.8.files <- list.files(file.path(data_base_path,"QC_screen-FGC_0008"), 
                                 pattern = "Control_vs_Plasmid_correctedFCs.tsv", recursive = T, full.names = T)

cleanr_lfc.9.files <- list.files(file.path(data_base_path,"QC_screen-FGC_0009"), 
                                 pattern = "Control_vs_Plasmid_correctedFCs.tsv", recursive = T, full.names = T)

bagel.8.files <- list.files(file.path(data_base_path,"QC_screen-FGC_0008"), 
                                 pattern = "Control_vs_Plasmid.bf", recursive = T, full.names = T)

bagel.9.files <- list.files(file.path(data_base_path,"QC_screen-FGC_0009"), 
                                 pattern = "Control_vs_Plasmid.bf", recursive = T, full.names = T)


read_cleanr_lfc <- function(files, project_id){
  ret <- NULL
  for(file in files){
    comp <- gsub("^.*?/(\\S+?_vs_plasmid.*?)/.*$","\\1",file)
    tp <- gsub("^(\\S+?)_.*$","\\1",comp)
    num_reps <- gsub("^.*?vs_plasmid_(._replicates.*)$","\\1",comp)
    ret <- rbind(ret, data.frame(read.delim(file, header=T, stringsAsFactors = F),
                                 project_id = project_id, comparison = comp, time_point = tp, 
                                 num_reps = num_reps, stringsAsFactors = F))
  }
  return(ret %>%
           mutate(gene_group = case_when(GENE %in% ess.genes$bagel_nonessential ~ "non_essential_Bagel",
                                         GENE %in% ess.genes$pan_cancer_Sanger ~ "pan_cancer_Sanger",
                                         TRUE ~ "Other")))
}


read_bagel_output <- function(files, ess = "hart"){
  ret <- NULL
  if(length(ess)>1){
    ess_genes <- ess
  }else if(ess == "hart"){
    ess_genes <- ess.genes$bagel_essential
  }else if(ess == "sanger"){
    ess_genes <- ess.genes$pan_cancer_Sanger
  }else{
    stop(paste("unknown essentiality option",ess))
  }
  for(file in files){
    comp <- gsub("^.*?/(\\S+?_vs_plasmid.*?)/.*$","\\1",file)
    tp <- gsub("^(\\S+?)_.*$","\\1",comp)
    num_reps <- gsub("^.*?vs_plasmid_(._replicates.*)$","\\1",comp)
    td <- read.delim(file, header=T, stringsAsFactors = F) %>%
      filter(GENE %in% c(ess_genes, ess.genes$bagel_nonessential)) %>%
      mutate(TP = GENE %in% ess_genes,
             comparison = comp, time_point = tp,
             replicates = num_reps) %>%
      add_ROC(score_col = "BF")
    ret <- rbind(ret, td)
  }
  return(ret)
}

```

```{r}

lfc_cleanr <- read_cleanr_lfc(cleanr_lfc.8.files, "FGC_0008") %>%
  rbind(read_cleanr_lfc(cleanr_lfc.9.files, "FGC_0009")) %>%
  mutate(time_point = factor(time_point, levels = c("baseline","d7","d14","d17")),
         gene_group = ifelse(GENE %in% genes.mod_fitn, "moderately_negative", gene_group))

data.bagel.hart.8 <- read_bagel_output(bagel.8.files, ess="hart")
data.bagel.hart.9 <- read_bagel_output(bagel.9.files, ess="hart")
data.bagel.sang.8 <- read_bagel_output(bagel.8.files, ess="sanger")
data.bagel.sang.9 <- read_bagel_output(bagel.9.files, ess="sanger")
data.bagel.mf.8 <- read_bagel_output(bagel.8.files, ess=genes.mod_fitn)
data.bagel.mf.9 <- read_bagel_output(bagel.9.files, ess=genes.mod_fitn)

```

# Log-fold change distributions

## 2 replicates

```{r}
lfc_cleanr %>%
  filter(gene_group != "Other" & (grepl("combn1",comparison) || grepl("QC",comparison))) %>%
  ggplot(aes(project_id, correctedFC, color = gene_group)) +
    geom_point(position = position_dodge(width=0.75)) +
    geom_boxplot(notch = T, fill=NA) +
    geom_hline(yintercept = 0, linetype="dashed") +
    facet_grid(~time_point) +
    ggtitle("logFC (corrected): 2 replicates")

```

## 2 vs 3 replicates

```{r}
lfc_cleanr %>%
  filter(gene_group != "Other" & project_id == "FGC_0008" & time_point == "d7") %>%
  ggplot(aes(num_reps, correctedFC, color = gene_group)) +
    geom_point(position = position_dodge(width=0.75)) +
    geom_boxplot(notch = T, fill=NA) +
    geom_hline(yintercept = 0, linetype="dashed") +
    facet_grid(~time_point) +
    ggtitle("logFC (corrected): FGC_0008: 2 vs 3 replicates")

```

# Bagel performance

## Precision-Recall

```{r}
pr.hart <- rbind(data.bagel.hart.8 %>%
                   filter(time_point == "d7") %>%
                   group_by(replicates) %>%
                   do(data.frame(get_PRROC(., "BF", group_col = "replicates"))) %>% 
                   mutate(screen="08"),
          data.bagel.hart.9 %>%
            filter(time_point == "d7") %>%
            group_by(replicates) %>% 
            do(data.frame(get_PRROC(., "BF", group_col = "replicates"))) %>%
            mutate(screen="09"))

pr.sang <- rbind(data.bagel.sang.8 %>%
                   filter(time_point == "d7") %>%
                   group_by(replicates) %>%
                   do(data.frame(get_PRROC(., "BF", group_col = "replicates"))) %>% 
                   mutate(screen="08"),
          data.bagel.sang.9 %>%
            filter(time_point == "d7") %>%
            group_by(replicates) %>% 
            do(data.frame(get_PRROC(., "BF", group_col = "replicates"))) %>%
            mutate(screen="09"))

pr.mf <- rbind(data.bagel.mf.8 %>%
                   filter(time_point == "d7") %>%
                   group_by(replicates) %>%
                   do(data.frame(get_PRROC(., "BF", group_col = "replicates"))) %>% 
                   mutate(screen="08"),
          data.bagel.mf.9 %>%
            filter(time_point == "d7") %>%
            group_by(replicates) %>% 
            do(data.frame(get_PRROC(., "BF", group_col = "replicates"))) %>%
            mutate(screen="09"))


ggplot(pr.sang, aes(Recall,Precision,color=screen, group=replicates)) +
  geom_line() +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  ggtitle("Precision-Recall curve: Sanger pan-cancer genes")

ggplot(pr.hart, aes(Recall,Precision,color=screen, group=replicates)) +
  geom_line() +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  ggtitle("Precision-Recall curve: Hart essentials")

ggplot(pr.mf, aes(Recall,Precision,color=screen, group=replicates)) +
  geom_line() +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  ggtitle("Precision-Recall curve: Moderately Negative fitness genes (DepMap)")

```


