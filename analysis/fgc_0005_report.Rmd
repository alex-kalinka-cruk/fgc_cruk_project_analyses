---
title: 'CDC7 drug-sensitivity CRISPR Knock-Out screen Analysis'
author: "Alex Kalinka"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    depth: 3
    highlight: tango
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
---


```{r,echo=F}
options(warn=-1)

desir_thresh <- 0.8

suppressMessages(library(knitr))
suppressMessages(library(tidyr))
suppressMessages(library(magrittr))
suppressMessages(library(ggplot2))
suppressMessages(library(GGally))
suppressMessages(library(dplyr))
suppressMessages(library(gt))
suppressMessages(library(ggsci))
suppressMessages(library(patchwork))
suppressMessages(library(crispRutils))
suppressMessages(library(GICC))

proj_data.path <- file.path("..","..","project_data","fgc_0005")

filter <- dplyr::filter
select <- dplyr::select
rename <- dplyr::rename
mutate <- dplyr::mutate

# Essential gene sets.
load("../data/ess.genes.rda")
mod_fitness.genes <- readRDS(file="../data/depmap_lfc_modfitn.rds")
val_data <- readRDS(file="../data/fgc0005_val-data.rds")$samples

# Normalized count data.
norm_lfc_fgc0005 <- readRDS(file=file.path(proj_data.path,"norm_lfc_fgc0005.rds"))

# Slow to run from scratch.
desir_perf.depl <- readRDS(file="../data/desir_fdr_perf_depleted.rds")
mle_desir_0.8.depl <- readRDS(file="../data/mle_depleted_desir_thresh_0.8.rds")
data.mageck <- readRDS(file=file.path(proj_data.path,"data.mageck.rds"))

desir_files <- list.files("~/data/az_cruk/cdc7", 
                          pattern = "DesirabilityGeneRanking.tsv", recursive = T, full.names = T)

count_files <- list.files("~/data/az_cruk/cdc7", 
                          pattern = "combined_counts.txt", recursive = T, full.names = T)

read_gene_summ <- function(files){
  ret <- NULL
  for(file in files){
    cell_line <- gsub("^.*?Comp-(\\S+?)\\/.*$","\\1",file)
    td <- read.delim(file, header=T, stringsAsFactors = F) %>%
      select(gene, TvCCvP_PositiveDesi, TvCCvP_NegativeDesi, TvC_negpval, TvC_pospval, TvC_LFC)
    ret <- rbind(ret, data.frame(cell_line = cell_line, td), stringsAsFactors=F)
  }
  return(ret)
}

read_counts <- function(files){
  ret <- list()
  for(file in files){
    cell_line <- gsub("^.*?Comp-(\\S+?)\\/.*$","\\1",file)
    ret[[cell_line]] <- read.delim(file, header=T, stringsAsFactors = F)
  }
  return(ret)
}

data.desir <- read_gene_summ(desir_files)

```

```{r,eval=F}
uncorr.counts <- read_counts(count_files)
```

```{r}
## Function library.
# Correct library depth in CRISPR count data and annotate essential and non-essential gene groups.
norm_logfc <- function(data, samples){
  csums <- colSums(data[,3:ncol(data)])
  # Use median of controls.
  mdn.ctrl <- median(csums[grepl("FGC000",names(csums))])
  data.lfc <- data %>%
    rowwise() %>%
    mutate(!!sym(samples[1]) := mdn.ctrl * !!sym(samples[1])/csums[names(csums)==samples[1]],
           !!sym(samples[2]) := mdn.ctrl * !!sym(samples[2])/csums[names(csums)==samples[2]],
           Yusa_v3_KO_Plasmid_FGC_batch_1 = mdn.ctrl*Yusa_v3_KO_Plasmid_FGC_batch_1/csums[names(csums)=="Yusa_v3_KO_Plasmid_FGC_batch_1"],
           Control_Plasmid.logFC.median = log2(median(c(!!sym(samples[1]),!!sym(samples[2])))) - 
             log2(Yusa_v3_KO_Plasmid_FGC_batch_1),
           gene_group = case_when(gene %in% ess.genes$pan_cancer_Sanger ~ "pan_cancer_Sanger",
                                  gene %in% ess.genes$bagel_nonessential ~ "non_essential_Bagel",
                                  gene %in% ess.genes$ribosomal_proteins ~ "ribosomal_proteins",
                                  TRUE ~ "Other")) %>%
    ungroup()
  return(data.lfc)
}

# Plotting corrected LFC for QC.
plot_lfc <- function(data, title){
  pl <- data %>%
    filter(!gene_group%in%c("Other","ribosomal_proteins")) %>%
    ggplot(aes(Control_Plasmid.logFC.median, fill=gene_group)) +
    geom_density(alpha=0.25) +
    geom_vline(xintercept = 0, linetype="dashed") +
    xlim(-8,2) +
    ggtitle(title)
  print(pl)
}

# Prep data for printing candidate table.
prep_4_cand_tbl <- function(data, desir_thresh, dcol_name = "TvCCvP_NegativeDesi"){
  type <- ifelse(grepl("Negative",dcol_name),"neg","pos")
  dcol <- sym(dcol_name)
  data %<>%
      mutate(hit = !!dcol >= desir_thresh) %>%
      tidyr::pivot_wider(id_cols = c(cell_line, gene), names_from = cell_line, values_from = c(!!dcol, TvC_LFC)) %>%
      dplyr::rowwise() %>%
      mutate(Desirability = ifelse(type == "neg",
                                   median(c(TvCCvP_NegativeDesi_HCT116,`TvCCvP_NegativeDesi_HT-29`,TvCCvP_NegativeDesi_RKO,
                                     TvCCvP_NegativeDesi_SW480)),
                                   median(c(TvCCvP_PositiveDesi_HCT116,`TvCCvP_PositiveDesi_HT-29`,TvCCvP_PositiveDesi_RKO,
                                     TvCCvP_PositiveDesi_SW480)))) %>%
      dplyr::ungroup() %>%
      filter(!is.na(Desirability) & gene != "Control")
  
  if(type == "neg"){
    data %<>%
      rename(D_HCT116 = TvCCvP_NegativeDesi_HCT116, `D_HT-29` = `TvCCvP_NegativeDesi_HT-29`,
             D_RKO = TvCCvP_NegativeDesi_RKO, `D_SW480` = `TvCCvP_NegativeDesi_SW480`,
             LFC_HCT116 = TvC_LFC_HCT116, `LFC_HT-29` = `TvC_LFC_HT-29`, LFC_RKO = TvC_LFC_RKO, LFC_SW480 = TvC_LFC_SW480,
             Gene = gene)
  }else{
    data %<>%
      rename(D_HCT116 = TvCCvP_PositiveDesi_HCT116, `D_HT-29` = `TvCCvP_PositiveDesi_HT-29`,
             D_RKO = TvCCvP_PositiveDesi_RKO, `D_SW480` = `TvCCvP_PositiveDesi_SW480`,
             LFC_HCT116 = TvC_LFC_HCT116, `LFC_HT-29` = `TvC_LFC_HT-29`, LFC_RKO = TvC_LFC_RKO, LFC_SW480 = TvC_LFC_SW480,
             Gene = gene)
  }
  return(data %>%
           select(Gene, Desirability, D_HCT116, D_SW480, D_RKO, `D_HT-29`, 
             LFC_HCT116, LFC_SW480, LFC_RKO, `LFC_HT-29`))
}


# Printing candidate table.
print_cand_table <- function(data, title, subtitle){
  tab <- data %>%
    gt() %>%
    tab_header(title = md(title),
               subtitle = md(subtitle)) %>%
    tab_spanner(label = "MAGeCK logFC", columns = c("LFC_HCT116", "LFC_RKO", "LFC_SW480", "LFC_HT-29")) %>%
    tab_spanner(label = "Desirability", columns = c("D_HCT116", "D_RKO", "D_SW480", "D_HT-29")) %>%
    fmt_number(columns = vars(Desirability, D_HCT116, D_HCT116, D_SW480, D_RKO, `D_HT-29`,
                              LFC_HCT116, LFC_SW480, LFC_RKO, `LFC_HT-29`),
               decimals = 3) %>%
    cols_align(align = "right", columns = TRUE) %>%
    data_color(
      columns = vars(Desirability),
      colors = scales::col_numeric(
        palette = paletteer::paletteer_d(
          palette = "ggsci::red_material"
        ) %>% as.character(),
        domain = NULL
      ),
      alpha = 0.8
    ) %>%
    data_color(columns = vars(D_HCT116,D_SW480,D_RKO,`D_HT-29`),
               colors = function(x) ifelse(x >= desir_thresh, "palegreen","#808080"),
        alpha = 0.8) %>%
    grand_summary_rows(
      columns = vars(LFC_HCT116,LFC_SW480,LFC_RKO,`LFC_HT-29`),
      fns = list(Median = "median"),
      formatter = fmt_number,
      decimals = 3) %>%
    cols_label(D_HCT116 = "HCT116", D_SW480 = "SW480", D_RKO = "RKO", `D_HT-29` = "HT-29",
               LFC_HCT116 = "HCT116", LFC_SW480 = "SW480", LFC_RKO = "RKO", `LFC_HT-29` = "HT-29") %>%
    tab_options(
      table.font.size = "80\\%",
      grand_summary_row.background.color = "#ACEACE80"
    )
  return(tab)
}

```

# Summary

* There are 22 depletion hits that are shared across at least 2 cell lines.
* The GO biological process 'regulation of cell cycle' is strongly enriched.
* There are few over-represented genes with the majority a hit in only 1 cell line.
* HT-29 is an outlier among the 4 colon cancer cell lines - this is corroborated by a recent paper classifying HT-29 as belonging to a different group to the other 3 cell lines.

# Approach for identifying shared hits

Four colon cancer cell lines were used in the study and this provides a means to identify shared hits, defined as candidate genes that are shared across two or more cell lines (as opposed to singleton candidates, defined as hits in only one cell line). When a hit occurs in more than one cell line, it strongly boosts the evidence that it is a true hit.

![The probability that a gene is a true hit is enhanced by occurring in more than 1 cell line screen. P_11 - probability that a hit is a true positive.](../images/Celllines_Alex.png)

In the following analysis, we extract and compare:

* **Shared** candidate genes at a False Discovery Rate (FDR) of 10%.
* **Singleton** candidate genes at an FDR of 10%.
* **Combined** shared and singleton candidates.

To identify shared candidates, we employ a Bayesian approach to infer the probability that a given shared hit is a true positive (Jakobsdottir and Weeks 2007) and then use these probabilities to calculate the threshold at which our gene score metric corresponds to an FDR of 10%. The probability that a shared candidate gene $i$ is a true positive given the data is

$$
\text{P}(\delta_{i}=1 \vert  \text{data}) = \frac{\prod_{t=0}^1 p_{t1}^{n_{it}}\theta_1}{\prod_{t=0}^1 p_{t0}^{n_{it}}\theta_0 + \prod_{t=0}^1 p_{t1}^{n_{it}}\theta_1}
$$

where $p_{t1}$ indicates the false negative rate when $t=0$ and the true positive rate when $t=1$, $\theta_0$ is the prevalence of negatives and $\theta_1$ is the prevalence of positives (all parameters are Maximum Likelihood Estimates), and $n_{it}$ indicates the number of cell lines in which gene $i$ produced test result $t$ (negative or positive).

Genes are ranked by a Desirability score metric which is based on a combination of adjusted p-values and log fold changes (logFC) taken from MAGeCK. A sliding Desirability threshold is then used to determine the threshold at which the FDR of shared hits corresponds to 10% (singleton hits are excluded).

# Cell line analysis

Comparison of genes with a log fold change below -0.25 across the four cell lines shows that HT-29 shares overall the fewest genes with the other three cell lines (see heatmap below). 

A recent paper analysing transcriptomic data for 34 colorectal cancer cell lines provides an explanation (Berg et al. 2017). In this paper they show that transcriptomic data resolves the 34 cell lines into two groups, one characterised as "colon-like" and the other as "Undifferentiated". HT-29 falls into the former group, with the remaining three cell lines falling into the latter group. Figure 6 from this paper is copied below showing the four cell lines from the present study highlighted in red boxes.

```{r}
# For assessing cell line LFC similarities.
jaccard_index <- function(genes, data_1, data_2, thresh){
  jacc_num <- length(intersect(genes[data_1 < thresh], genes[data_2 < thresh]))
  jacc_denom <- length(union(genes[data_1 < thresh], genes[data_2 < thresh]))
  return(jacc_num/jacc_denom)
}

# Jaccard index for negative LFC
ji <- data.desir %>%
  tidyr::pivot_wider(id_cols = gene, names_from = cell_line,
                     values_from = TvC_LFC) %>%
  rowwise() %>%
  mutate(median.lfc = median(c(HCT116,`HT-29`,RKO,SW480), na.rm=T)) %>%
  ungroup() %>%
  arrange(median.lfc) %>%
  head(n=150)
  
jd <- c(jaccard_index(ji$gene, ji$`HT-29`, ji$HCT116, -0.25),
        jaccard_index(ji$gene, ji$`HT-29`, ji$SW480, -0.25),
        jaccard_index(ji$gene, ji$`HT-29`, ji$RKO, -0.25),
        jaccard_index(ji$gene, ji$HCT116, ji$SW480, -0.25),
        jaccard_index(ji$gene, ji$HCT116, ji$RKO,-0.25),
        jaccard_index(ji$gene, ji$SW480, ji$RKO, -0.25))
jacc.mat <- matrix(c(1,jd[1:3],
                         jd[1],1,jd[4:5],
                         jd[c(2,4)],1,jd[6],
                         jd[c(3,5,4)],1), 4, 4, byrow = T)
colnames(jacc.mat) <- rownames(jacc.mat) <- c("HT-29","HCT116","SW480","RKO")

ggcorr(jacc.mat, label = T, label_round = 3, cor_matrix = jacc.mat, limits=c(0.25,0.6),
       midpoint = 0.4) +
  labs(title = "Cell line log-fold-change (LFC) similarity:",
       subtitle =  "Jaccard Index for top 150 negative LFC genes")

```

![Classification of colorectal cell lines: Berg et al. 2017 Figure 6. Red boxes highlight the four cell lines used in the present study, and a red line separates the two cell line classes defined using transcriptomic data.](../images/fig-6-bergetal2017.png)

# Shared Hits

## Desirability Threshold

Below is the curve used to define the Desirability threshold that corresponds to an FDR of 10% for shared hits for depleted genes. The Desirability threshold is approximately 0.8.

```{r}
pl <- desir_perf.depl %>%
  filter(!Desir_threshold %in% c(0.88,0.799,0.794,0.79,0.789)) %>%
  ggplot(aes(Desir_threshold, FDR.common)) +
  geom_point() +
  geom_smooth() +
  geom_segment(aes(x = 0.8, y = -0.03, xend = 0.8, yend = 0.1), linetype = "dashed") +
  geom_segment(aes(x = 0.67, y = 0.1, xend = 0.8, yend = 0.1), linetype = "dashed") +
  xlab("Desirability Threshold") +
  ylab("FDR of shared hits") +
  ggtitle("Desirability 10% False Discovery Rate (FDR) Threshold: Depleted genes")

suppressMessages(print(pl))

```

## Candidate Genes

```{r}
shared_desir <- prep_4_cand_tbl(data.desir, desir_thresh) %>%
  mutate(probability_hit = mle_desir_0.8.depl$delta$delta_pos)

cand_df <- shared_desir %>%
  filter(probability_hit > 0.5) %>%
  select(-probability_hit) %>%
  arrange(desc(Desirability))

shared_tab <- print_cand_table(cand_df, 
                               title = "**CDC7** drug-sensitivity candidate genes (**shared** hits)",
                               subtitle = "**Depleted** hits at 10% FDR (ranked by median Desirability)")

shared_tab

```

## GO enrichments

![STRING-GO-shared](../../project_data/fgc_0005/images/String_GO.png)

## Interactions

![STRING-Interactions-shared](../../project_data/fgc_0005/images/String_Interactions.png)


## Reactome enrichments

![STRING-Reactome-shared](../../project_data/fgc_0005/images/String_Reactome.png)

# Singleton Hits

## Candidate Genes

```{r}
# Singleton hits.
singleton_hits <- setdiff((data.mageck %>%
  filter(neg.fdr <= 0.1))$gene, 
  cand_df$Gene)

singleton_desir <- prep_4_cand_tbl(data.desir, desir_thresh) %>%
  mutate(hit = Gene %in% singleton_hits)

cand_df.sgl <- singleton_desir %>%
  filter(hit) %>%
  select(-hit) %>%
  arrange(desc(Desirability))

shared_tab.sgl <- print_cand_table(cand_df.sgl, 
                               title = "**CDC7** drug-sensitivity candidate genes (**singleton** hits)",
                               subtitle = "**Depleted** hits at 10% FDR (ranked by median Desirability)")

shared_tab.sgl

```

## GO enrichments

![STRING-GO-singletons](../../project_data/fgc_0005/images/String_GO-singl.png)

## Interactions

![STRING-Interactions-singletons](../../project_data/fgc_0005/images/String_Interactions-singl.png)

## Reactome enrichments

There were no Reactome enrichments.

# Combined Hits

## Candidate Genes

```{r}
# Combined hits.
combined_hits <- union((data.mageck %>%
  filter(neg.fdr <= 0.1))$gene, 
  cand_df$Gene)

combined_desir <- prep_4_cand_tbl(data.desir, desir_thresh) %>%
  mutate(hit = Gene %in% combined_hits)

cand_df.comb <- combined_desir %>%
  filter(hit) %>%
  select(-hit) %>%
  arrange(desc(Desirability))

combined_tab.sgl <- print_cand_table(cand_df.comb, 
                               title = "**CDC7** drug-sensitivity candidate genes (**combined** hits)",
                               subtitle = "**Depleted** hits at 10% FDR (ranked by median Desirability)")

combined_tab.sgl

```

## GO enrichments

![STRING-GO-combined](../../project_data/fgc_0005/images/String_GO-comb.png)

## Interactions

![STRING-Interactions-combined](../../project_data/fgc_0005/images/String_Interactions-comb.png)

## Reactome enrichments

![STRING-Reactome-combined](../../project_data/fgc_0005/images/String_Reactome-comb.png)

# Over-represented Genes

While the goal of the study was to discover gene knock-outs that enhance the sensitivity of colon cancer cells to a CDC7 drug, it is also of interest to examine any genes that potentially exhibit over-representation after exposure to the drug.

## Shared Hits

No shared hits with Desirability > 0.9.

## Singleton Hits

### Candidate Genes

```{r}
# Singleton hits.
singleton_hits.or <- (data.mageck %>%
  filter(pos.fdr <= 0.1 & pos.lfc > 0))$gene

singleton_desir.or <- prep_4_cand_tbl(data.desir, desir_thresh, dcol_name = "TvCCvP_PositiveDesi") %>%
  mutate(hit = Gene %in% singleton_hits.or)

cand_df.sgl.or <- singleton_desir.or %>%
  filter(hit) %>%
  select(-hit) %>%
  arrange(desc(Desirability))

shared_tab.sgl.or <- print_cand_table(cand_df.sgl.or, 
                               title = "**CDC7** drug over-representation candidate genes (**singleton** hits)",
                               subtitle = "**Over-represented** hits at 10% FDR (ranked by median Desirability)")

shared_tab.sgl.or

```

### GO enrichments

![STRING-GO-over-represented](../../project_data/fgc_0005/images/String_GO-over-rep.png)

### Interactions

![STRING-Interactions-over-represented](../../project_data/fgc_0005/images/String_Interactions-over-rep.png)

### Reactome enrichments

![STRING-Reactome-over-represented](../../project_data/fgc_0005/images/String_Reactome-over-rep.png)

# QC

```{r}
# QC-related data and functions.
# Data kept locally.
mageck_files <- list.files("~/data/az_cruk/cdc7", 
                           pattern = "Treatment_vs_Control.gene_summary.txt", recursive = T, full.names = T)
mageck_files.cvp <- list.files("~/data/az_cruk/cdc7", 
                           pattern = "Control_vs_Plasmid.gene_summary.txt", recursive = T, full.names = T)
mageck_files.tvp <- list.files("~/data/az_cruk/cdc7", 
                           pattern = "Treatment_vs_Plasmid.gene_summary.txt", recursive = T, full.names = T)

count_files <- list.files("~/data/az_cruk/cdc7", pattern="combined_counts.txt", recursive=T, full.names=T)
desir_files <- list.files("~/data/az_cruk/cdc7", 
                          pattern = "DesirabilityGeneRanking.tsv", recursive = T, full.names = T)
bagel_files.ctrl_pl <- list.files("~/data/az_cruk/cdc7",
                          pattern = "Control_vs_Plasmid.bf", recursive = T, full.names = T)
bagel_files.treat_pl <- list.files("~/data/az_cruk/cdc7",
                          pattern = "Treatment_vs_Plasmid.bf", recursive = T, full.names = T)

read_gene_summ <- function(files, type = "mageck"){
  ret <- NULL
  for(file in files){
    cell_line <- gsub("^.*?Comp-(\\S+?)\\/.*$","\\1",file)
    if(type == "mageck"){
      td <- read.table(file, header=T, stringsAsFactors = F) %>%
        select(id, neg.score, neg.p.value, neg.fdr, neg.rank, neg.lfc, pos.score, pos.p.value, pos.fdr, pos.rank, pos.lfc) %>%
        rename(gene = id)
    }else{
      td <- read.delim(file, header=T, stringsAsFactors = F) %>%
        select(gene, TvCCvP_PositiveDesi, TvCCvP_NegativeDesi, TvC_negpval, TvC_pospval, TvC_LFC)
    }
    ret <- rbind(ret, data.frame(cell_line = cell_line,td), stringsAsFactors=F)
  }
  return(ret)
}


read_bagel_output <- function(files, ess = "hart"){
  ret <- NULL
  if(length(ess)>1){
    ess_genes <- ess
  }else if(ess == "hart"){
    ess_genes <- ess.genes$bagel_essential
  }else if(ess == "sanger"){
    ess_genes <- ess.genes$pan_cancer_Sanger
  }else{
    stop(paste("unknown essentiality option",ess))
  }
  for(file in files){
    cell_line <- gsub("^.*?Comp-(\\S+?)\\/.*$","\\1",file)
    td <- read.table(file, header=T, stringsAsFactors = F) %>%
      filter(GENE %in% c(ess_genes, ess.genes$bagel_nonessential)) %>%
      mutate(TP = GENE %in% ess_genes,
             cell_line = cell_line) %>%
      add_ROC(score_col = "BF")
    ret <- rbind(ret, td)
  }
  return(ret)
}


norm_counts <- function(data, type){
  samples <- colnames(data)[grepl("^FGC",colnames(data))]
  samples <- samples[samples %in% val_data$name[val_data$class==type]]
  csums <- colSums(data[,3:ncol(data)])
  # Use median of controls for scaling normalized data.
  mdn.ctrl <- median(csums[grepl("FGC",names(csums))])
  data.norm <- data %>%
    mutate(!!sym(samples[1]) := mdn.ctrl * !!sym(samples[1])/csums[names(csums)==samples[1]],
         !!sym(samples[2]) := mdn.ctrl * !!sym(samples[2])/csums[names(csums)==samples[2]],
         Yusa_v3_KO_Plasmid_FGC_batch_1 = mdn.ctrl*Yusa_v3_KO_Plasmid_FGC_batch_1/csums[names(csums)=="Yusa_v3_KO_Plasmid_FGC_batch_1"],
         gene_group = case_when(gene %in% ess.genes$bagel_essential ~ "essential_Hart",
                                gene %in% ess.genes$pan_cancer_Sanger ~ "pan_cancer_Sanger",
                                gene %in% ess.genes$bagel_nonessential ~ "non_essential_Hart",
                                gene %in% mod_fitness.genes ~ "moderately_negative",
                                TRUE ~ "Other"))
  if(length(samples) == 3){
    data.norm %<>%
      mutate(!!sym(samples[3]) := mdn.ctrl * !!sym(samples[3])/csums[names(csums)==samples[3]])
  }
  return(data.norm)
}


read_counts <- function(files, type){
  ret <- list()
  for(file in files){
    comp <- gsub("^.*?/Comp-(\\S+?).counts.*$","\\1",file)
    ret[[comp]] <- read.delim(file) %>%
      norm_counts(type)
  }
  return(ret)
}


# Data.
data.mageck <- read_gene_summ(mageck_files)
data.mageck.cvp <- read_gene_summ(mageck_files.cvp)
data.mageck.tvp <- read_gene_summ(mageck_files.tvp)
data.bagel.ctrl_pl.hart <- read_bagel_output(bagel_files.ctrl_pl)
data.bagel.treat_pl.hart <- read_bagel_output(bagel_files.treat_pl)
data.bagel.ctrl_pl.sang <- read_bagel_output(bagel_files.ctrl_pl, ess="sanger")
data.bagel.treat_pl.sang <- read_bagel_output(bagel_files.treat_pl, ess="sanger")
data.bagel.ctrl_pl.mf <- read_bagel_output(bagel_files.ctrl_pl, ess=mod_fitness.genes)
data.bagel.treat_pl.mf <- read_bagel_output(bagel_files.treat_pl, ess=mod_fitness.genes)

data.counts.bl <- read_counts(count_files, type = "baseline")
data.counts.ctrl <- read_counts(count_files, type = "control")
data.counts.trt <- read_counts(count_files, type = "treatment")

```


## Log-fold change

Essential gene sets are clearly differentiated from the non-essential set for all cell lines indicating high quality data.

```{r, eval=F}
lfc_hct116 <- norm_logfc(uncorr.counts$HCT116, 
                         c("FGC0005_01_04_04","FGC0005_01_04_05","FGC0005_01_04_06"))
lfc_sw480 <- norm_logfc(uncorr.counts$SW480, 
                         c("FGC0005_01_03_03","FGC0005_01_03_04"))
lfc_rko<- norm_logfc(uncorr.counts$RKO, 
                         c("FGC0005_01_02_03","FGC0005_01_02_04"))
lfc_ht29<- norm_logfc(uncorr.counts$`HT-29`, 
                         c("FGC0005_01_01_03","FGC0005_01_01_04"))

plot_lfc(norm_lfc_fgc0005$HCT116, "HCT116 Control vs Plasmid: essential vs nonessential logFC")

plot_lfc(norm_lfc_fgc0005$SW480, "SW480 Control vs Plasmid: essential vs nonessential logFC")

plot_lfc(norm_lfc_fgc0005$RKO, "RKO Control vs Plasmid: essential vs nonessential logFC")

plot_lfc(norm_lfc_fgc0005$HT29, "HT-29 Control vs Plasmid: essential vs nonessential logFC")

```

```{r}
data.mageck.cvp %>%
  mutate(gene_group = case_when(gene %in% ess.genes$bagel_essential ~ "essential_Hart",
                                gene %in% ess.genes$pan_cancer_Sanger ~ "pan_cancer_Sanger",
                                gene %in% ess.genes$bagel_nonessential ~ "non_essential_Hart",
                                gene %in% mod_fitness.genes ~ "moderately_negative",
                                TRUE ~ "Other")) %>%
  filter(gene_group != "Other") %>%
  ggplot(aes(cell_line, neg.lfc, color = gene_group)) +
  geom_point(position = position_dodge(width=0.75)) +
  geom_boxplot(notch=T) +
  geom_hline(yintercept = 0, linetype="dashed") +
  ylab("Log2 Fold Change") +
  facet_grid(~cell_line, space = "free_x", scale = "free_x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  ggtitle("Control vs Plasmid Log fold change: cell line and gene set comparison")

data.mageck.tvp %>%
  mutate(gene_group = case_when(gene %in% ess.genes$bagel_essential ~ "essential_Hart",
                                gene %in% ess.genes$pan_cancer_Sanger ~ "pan_cancer_Sanger",
                                gene %in% ess.genes$bagel_nonessential ~ "non_essential_Hart",
                                gene %in% mod_fitness.genes ~ "moderately_negative",
                                TRUE ~ "Other")) %>%
  filter(gene_group != "Other") %>%
  ggplot(aes(cell_line, neg.lfc, color = gene_group)) +
  geom_point(position = position_dodge(width=0.75)) +
  geom_boxplot(notch=T) +
  geom_hline(yintercept = 0, linetype="dashed") +
  ylab("Log2 Fold Change") +
  facet_grid(~cell_line, space = "free_x", scale = "free_x") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  ggtitle("Treatment vs Plasmid Log fold change: cell line and gene set comparison")

```

## Reproducibility of counts

GICC values above 0.6 indicate data generally considered to be of high reproducibility.

```{r}
run_gicc <- function(data){
  samps <- colnames(data)[3:(ncol(data)-1)]
  samps[grepl("^FGC",samps)] <- "control"
  td <- data.frame(id = samps, t(data[,3:(ncol(data)-1)]), stringsAsFactors = F)
  gicc <- GICC(td)
  return(gicc$GICC$GICC.1)
}

calc_gicc <- function(data_list){
  ret <- NULL
  for(comp in names(data_list)){
    td <- data_list[[comp]] %>%
      filter(gene_group != "Other") %>%
      group_by(gene_group) %>%
      do(data.frame(cell_line = comp, GICC = run_gicc(.), stringsAsFactors = F))
    ret <- rbind(ret, td)
  }
  return(ret)
}

```

```{r}
gicc.counts <- rbind(calc_gicc(data.counts.bl) %>%
                       mutate(time_point = "baseline"),
                     calc_gicc(data.counts.ctrl) %>%
                       mutate(time_point = "control"),
                     calc_gicc(data.counts.trt) %>%
                       mutate(time_point = "treatment"))

gicc.counts %>% 
  ggplot(aes(cell_line, GICC, group=gene_group, color=gene_group)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0.6, linetype = "dashed") +
  facet_grid(~time_point) +
  theme(axis.text.x = element_text(angle = -30, hjust = 0)) +
  ggtitle("Reproducibility of normalized counts: GICC")

```

## Precision-Recall

High values for AUC (Area Under the Curve) for the precision-recall curves below indicates data of high quality - all cell lines and gene sets are above 0.9. Likewise, high sensitivity values at an FDR of 10% indicate high quality data, and all the cell lines and gene sets have sensitivities above 80%.

```{r}
pr.hart <- data.bagel.ctrl_pl.hart %>%
  group_by(cell_line) %>%
  do(data.frame(get_PRROC(., "BF", group_col = "cell_line")))

pr.sang <- data.bagel.ctrl_pl.sang %>%
  group_by(cell_line) %>%
  do(data.frame(get_PRROC(., "BF", group_col = "cell_line")))

pr.mf <- data.bagel.ctrl_pl.mf %>%
  group_by(cell_line) %>%
  do(data.frame(get_PRROC(., "BF", group_col = "cell_line")))

# Plots.
ggplot(pr.sang, aes(Recall,Precision,color=cell_line, group=cell_line)) +
  geom_line() +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  ggtitle("Precision-Recall: pan-cancer Sanger")

ggplot(pr.hart, aes(Recall,Precision,color=cell_line, group=cell_line)) +
  geom_line() +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  ggtitle("Precision-Recall: Hart essentials")

ggplot(pr.mf, aes(Recall,Precision,color=cell_line, group=cell_line)) +
  geom_line() +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  ggtitle("Precision-Recall: moderately negative fitness defects")

plot.auprrc <- rbind(pr.sang %>%
                  group_by(cell_line) %>%
                  summarise(AUPrRc = AUPrRc[1]) %>%
                  mutate(gene_group = "pan_cancer_Sanger"),
                pr.hart %>%
                  group_by(cell_line) %>%
                  summarise(AUPrRc = AUPrRc[1]) %>%
                  mutate(gene_group = "essential_Hart"),
                pr.mf %>%
                  group_by(cell_line) %>%
                  summarise(AUPrRc = AUPrRc[1]) %>%
                  mutate(gene_group = "moderately_negative")) %>%
  ggplot(aes(cell_line, AUPrRc, group = gene_group, color = gene_group)) +
  geom_point() +
  geom_line() +
  ggtitle("AUC Precision-Recall: cell line and gene set comparison")

plot.fdr_prrc <- rbind(pr.sang %>%
                  group_by(cell_line) %>%
                  summarise(Sensitivity_FDR_10pct = Sensitivity_FDR_10pct[1]) %>%
                  mutate(gene_group = "pan_cancer_Sanger"),
                pr.hart %>%
                  group_by(cell_line) %>%
                  summarise(Sensitivity_FDR_10pct = Sensitivity_FDR_10pct[1]) %>%
                  mutate(gene_group = "essential_Hart"),
                pr.mf %>%
                  group_by(cell_line) %>%
                  summarise(Sensitivity_FDR_10pct = Sensitivity_FDR_10pct[1]) %>%
                  mutate(gene_group = "moderately_negative")) %>%
  ggplot(aes(cell_line, Sensitivity_FDR_10pct, group = gene_group, color = gene_group)) +
  geom_point() +
  geom_line() +
  ggtitle("Sensitivity at 10% FDR: cell line and gene set comparison")

plot.auprrc / plot.fdr_prrc

```


# References

Berg, K. C. G. et al. 2017. Multi-omics of 34 colorectal cancer cell lines - a resource for biomedical studies. *Molecular Cancer* **16**: 116.

Jakobsdottir, J. and Weeks, D. E. 2007. Estimating prevalence, false-positive rate, and false-negative rate with use of repeated testing when true responses are unknown. *Am J Hum Genet* **81**: 1111-1113.


