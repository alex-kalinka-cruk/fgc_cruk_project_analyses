---
title: 'CDC7 drug-sensitivity CRISPR Knock-Out screen Analysis'
author: "Alex Kalinka"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    depth: 3
    highlight: tango
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
---


```{r,echo=F}
options(warn=-1)

desir_thresh <- 0.8

suppressMessages(library(knitr))
suppressMessages(library(tidyr))
suppressMessages(library(magrittr))
suppressMessages(library(ggplot2))
suppressMessages(library(dplyr))
suppressMessages(library(gt))
suppressMessages(library(ggsci))

proj_data.path <- file.path("..","..","project_data","fgc_0005","images")

filter <- dplyr::filter
select <- dplyr::select
rename <- dplyr::rename
mutate <- dplyr::mutate

# Slow to run from scratch.
desir_perf.depl <- readRDS(file="../data/desir_fdr_perf_depleted.rds")
mle_desir_0.8.depl <- readRDS(file="../data/mle_depleted_desir_thresh_0.8.rds")

desir_files <- list.files("~/data/az_cruk/cdc7", 
                          pattern = "DesirabilityGeneRanking.tsv", recursive = T, full.names = T)

read_gene_summ <- function(files){
  ret <- NULL
  for(file in files){
    cell_line <- gsub("^.*?Comp-(\\S+?)\\/.*$","\\1",file)
    td <- read.delim(file, header=T, stringsAsFactors = F) %>%
      select(gene, TvCCvP_PositiveDesi, TvCCvP_NegativeDesi, TvC_negpval, TvC_pospval, TvC_LFC)
    ret <- rbind(ret, data.frame(cell_line = cell_line, td), stringsAsFactors=F)
  }
  return(ret)
}

data.desir <- read_gene_summ(desir_files)

```

```{r}
# Prep data for printing candidate table.
prep_4_cand_tbl <- function(data, desir_thresh, dcol_name = "TvCCvP_NegativeDesi"){
  dcol <- sym(dcol_name)
  data %<>%
      mutate(hit = !!dcol >= desir_thresh) %>%
      tidyr::pivot_wider(id_cols = c(cell_line, gene), names_from = cell_line, values_from = c(TvCCvP_NegativeDesi,TvC_LFC)) %>%
      dplyr::rowwise() %>%
      mutate(Desirability = median(c(TvCCvP_NegativeDesi_HCT116,`TvCCvP_NegativeDesi_HT-29`,TvCCvP_NegativeDesi_RKO,
                                     TvCCvP_NegativeDesi_SW480))) %>%
      dplyr::ungroup() %>%
      filter(!is.na(Desirability) & gene != "Control") %>%
      rename(D_HCT116 = TvCCvP_NegativeDesi_HCT116, `D_HT-29` = `TvCCvP_NegativeDesi_HT-29`,
             D_RKO = TvCCvP_NegativeDesi_RKO, `D_SW480` = `TvCCvP_NegativeDesi_SW480`,
             LFC_HCT116 = TvC_LFC_HCT116, `LFC_HT-29` = `TvC_LFC_HT-29`, LFC_RKO = TvC_LFC_RKO, LFC_SW480 = TvC_LFC_SW480,
             Gene = gene) %>%
      select(Gene, Desirability, D_HCT116, D_SW480, D_RKO, `D_HT-29`, 
             LFC_HCT116, LFC_SW480, LFC_RKO, `LFC_HT-29`)
  return(data)
}

cand_df <- prep_4_cand_tbl(data.desir, desir_thresh) %>%
  mutate(probability_hit = mle_desir_0.8.depl$delta$delta_pos) %>%
  filter(probability_hit > 0.5) %>%
  select(-probability_hit) %>%
  arrange(desc(Desirability))

```

# Summary


# Approach



# Sensitivity Analysis

## Desirability Threshold

```{r}
pl <- desir_perf.depl %>%
  filter(!Desir_threshold %in% c(0.88,0.799,0.794,0.79,0.789)) %>%
  ggplot(aes(Desir_threshold, FDR.common)) +
  geom_point() +
  geom_smooth() +
  geom_segment(aes(x = 0.8, y = -0.03, xend = 0.8, yend = 0.1), linetype = "dashed") +
  geom_segment(aes(x = 0.67, y = 0.1, xend = 0.8, yend = 0.1), linetype = "dashed") +
  ylab("Desirability Threshold") +
  xlab("FDR of shared hits") +
  ggtitle("Desirability 10% FDR Threshold: Depletion")

suppressMessages(print(pl))

```

## Gene Candidates

```{r}
cand_df %>%
  gt() %>%
  tab_header(title = md("**CDC7** drug-sensitivity candidate genes"),
             subtitle = md("**Depletion** hits at 10% FDR (ranked by median Desirability)")) %>%
  tab_spanner(label = "MAGeCK logFC", columns = c("LFC_HCT116", "LFC_RKO", "LFC_SW480", "LFC_HT-29")) %>%
  tab_spanner(label = "Desirability", columns = c("D_HCT116", "D_RKO", "D_SW480", "D_HT-29")) %>%
  fmt_number(columns = vars(Desirability, D_HCT116, D_HCT116, D_SW480, D_RKO, `D_HT-29`,
                            LFC_HCT116, LFC_SW480, LFC_RKO, `LFC_HT-29`),
             decimals = 3) %>%
  cols_align(align = "right", columns = TRUE) %>%
  data_color(
    columns = vars(Desirability),
    colors = scales::col_numeric(
      palette = paletteer::paletteer_d(
        palette = "ggsci::red_material"
      ) %>% as.character(),
      domain = NULL
    ),
    alpha = 0.8
  ) %>%
  data_color(columns = vars(D_HCT116,D_SW480,D_RKO,`D_HT-29`),
             colors = function(x) ifelse(x >= desir_thresh, "palegreen","#808080"),
      alpha = 0.8) %>%
  grand_summary_rows(
    columns = vars(LFC_HCT116,LFC_SW480,LFC_RKO,`LFC_HT-29`),
    fns = list(Median = "median"),
    formatter = fmt_number,
    decimals = 3) %>%
  cols_label(D_HCT116 = "HCT116", D_SW480 = "SW480", D_RKO = "RKO", `D_HT-29` = "HT-29",
             LFC_HCT116 = "HCT116", LFC_SW480 = "SW480", LFC_RKO = "RKO", `LFC_HT-29` = "HT-29") %>%
  tab_options(
    table.font.size = "80\\%",
    grand_summary_row.background.color = "#ACEACE80"
  )

```

## GO enrichments

![String-GO](../../project_data/fgc_0005/images/String_GO.png)

## Interactions

![String-Interactions](../../project_data/fgc_0005/images/String_Interactions.png)


## Reactome enrichments

![String-Reactome](../../project_data/fgc_0005/images/String_Reactome.png)

# Enriched Genes

No shared hits with Desirability > 0.9.


# QC

## HCT116


## SW480


## RKO


## HT-29


# References




