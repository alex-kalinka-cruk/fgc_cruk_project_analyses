---
title: 'TechDev_0001: MOI theoretical predictions'
author: "Alex Kalinka"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    depth: 3
    highlight: tango
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
---

# Setup

```{r,echo=F}
options(warn=-1)

suppressMessages(library(knitr))
suppressMessages(library(tidyr))
suppressMessages(library(magrittr))
suppressMessages(library(ggplot2))
suppressMessages(library(dplyr))
suppressMessages(library(splines2))
suppressMessages(library(patchwork))
suppressMessages(library(fgcQC))


filter <- dplyr::filter
select <- dplyr::select
rename <- dplyr::rename
mutate <- dplyr::mutate

qc <- readRDS(file = "../data/qc_techdev_0001.rds") %>%
  #filter(!grepl("T",MOI)) %>%
  mutate(moi = MOI, MOI = as.numeric(gsub("[T/F]","",MOI)))


cleanr.files <- list.files("~/data/az_cruk/techdev_0001/", pattern = "Control_vs_Plasmid_correctedFCs.tsv",
                           full.names = T, recursive = T)
counts.files <- list.files("~/data/az_cruk/techdev_0001/", pattern = "combined_counts.txt",
                           full.names = T, recursive = T)

read_lfc <- function(files, type = "cleanr"){
  ret <- NULL
  for(file in files){
    if(!grepl("MOI",file)) next
    
    comp <- gsub(paste("^.*?(MOI.*)\\/",type,".*$",sep=""),"\\1",file)
    moi <- gsub("^MOI-(.*?)-.*$","\\1",comp)
    time <- gsub("^MOI-.*?-(.*)$","\\1",comp)

    td <- read.delim(file, header=T, stringsAsFactors = F, sep="\t")
    if(type != "lfc"){    
      td %<>%
        pivot_longer(cols = starts_with("TECHDEV0001"), names_to = "sample_id", values_to = "count")
    }
    td %<>%
      mutate(comparison = comp, MOI = moi, time_point = time)
    ret <- rbind(ret, td)
  }
  return(ret)
}



lfc <- read_lfc(cleanr.files)
counts <- read_lfc(counts.files, type = "counts")


```

# MOI empirical

```{r}
p1 <- qc %>%
  filter(time_point == "day14") %>%
  ggplot(aes(x=MOI, y=NNMD_robust.ctrl_plasmid.pan_cancer_Sanger)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype="dashed") +
  geom_smooth(method = "nls",
              formula = y ~ A - (A/(1+exp(-x*B))^(1/v)),
              method.args = list(start = c(A = -6.5, B = 2, v = 1.2)),
              se=F) +
  ggtitle("Day 14: logFC effect size (NNMD) essential vs nonessential")

```


# MOI theoretical 

```{r}
prob_pairing_non_neutral_guide <- function(moi, pe){
  # max number of viruses per cell (at MOI of 5, ppois(20,5,lower.tail = F) < 1e-7)
  max_n <- 20
  n <- 2:max_n
  ret <- NULL
  for(i in n){
    pb_nonzero <- 1 - dbinom(0, i, pe)
    ret <- append(ret, dpois(i, moi) * pb_nonzero)
  }
  return(sum(ret))
}

moi <- c(0.3, 0.75, 1, 2.12, 2.5, 5)
ppair <- sapply(moi, prob_pairing_non_neutral_guide, 0.1)

data.frame(MOI = moi, prob_pair_ess = ppair) %>%
  ggplot(aes(MOI, prob_pair_ess)) +
  geom_point() +
  geom_smooth(method = "lm",
              formula = y ~ splines2::bSpline(x, df = 3),
              se=F)

```

# Counts

```{r}
counts %>%
  filter(time_point == "day14") %>%
  ggplot(aes(MOI, count)) +
  geom_point() +
  geom_boxplot()

counts %>%
  filter(time_point == "day14" & gene %in% c(crispr_gene_sets$essential$pan_cancer_Sanger, 
                     crispr_gene_sets$essential$hart_nonessential)) %>%
  mutate(gene_group = ifelse(gene %in% crispr_gene_sets$essential$pan_cancer_Sanger, "pan_cancer_Sanger","hart_nonessential")) %>%
  ggplot(aes(MOI, count, color = gene_group)) +
  geom_point(position = position_dodge(width=0.75)) +
  geom_boxplot()


```

# logFC

## Essential vs Non-essential

```{r}
lfc.pc <- lfc %>%
  filter(GENE %in% c(crispr_gene_sets$essential$pan_cancer_Sanger, 
                     crispr_gene_sets$essential$hart_nonessential)) %>%
  mutate(gene_group = ifelse(GENE %in% crispr_gene_sets$essential$pan_cancer_Sanger, "pan_cancer_Sanger","hart_nonessential"))

lfc.pc %>%
  filter(time_point == "day14") %>%
  ggplot(aes(MOI, correctedFC, color = gene_group)) +
  geom_point(position = position_dodge(width=0.75)) +
  geom_boxplot(notch=T) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ggtitle("Day 14: Control vs Plasmid logFC by MOI")

```

## Control guides

```{r}
lfc %>%
  filter(time_point == "day14" & GENE %in% c("Control")) %>%
  mutate(gene_group = "Control") %>%
  ggplot(aes(MOI, correctedFC, color = gene_group)) +
  geom_point(position = position_dodge(width=0.75)) +
  geom_boxplot(notch=T) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ylim(-2.5,2) + 
  ggtitle("Day 14: Control vs Plasmid logFC by MOI")


qc %>%
    filter(time_point=="day14" & SampleClass!="plasmid") %>%
    ggplot(aes(moi,NNMD_robust.ctrl_plasmid.control_guides,color=moi)) +
    geom_point(cex = 3) +
  geom_hline(yintercept = 0, linetype="dashed") +
    ggtitle("Day 14: logFC differential (NNMD) of Non-targeting Controls")

```

## SD vs MAD

```{r}
lfc %>%
  filter(time_point == "day14") %>%
  group_by(MOI) %>%
  summarise(logFC_MAD = mad(correctedFC),
            logFC_SD = sd(correctedFC)) %>%
  ungroup() %>%
  ggplot(aes(MOI, logFC_SD)) +
  geom_bar(stat = "identity") +
  ggtitle("SD of logFC by MOI")

```

## Delta across time points

```{r}
lfc %>%
  filter(time_point == "day14") %>%
  pivot_wider(id_cols = SEQID, names_from = MOI, names_prefix = "logFC_MOI_", values_from = correctedFC) %>%
  mutate(abs_delta_logFC_MOI_0.3_5F = abs(logFC_MOI_0.3 - logFC_MOI_5F)) %>%
  ggplot(aes(logFC_MOI_0.3, abs_delta_logFC_MOI_0.3_5F)) +
  geom_hex() +
  geom_smooth() +
  geom_vline(xintercept = 0, linetype="dashed") +
  ggtitle("logFC Delta: MOI 0.3 vs MOI 5F")

```

## GICC

```{r}
qc %>%
  filter(time_point=="day14" & SampleClass!="plasmid") %>%
  ggplot(aes(moi,GICC.ctrl_plasmid.hart_nonessential,color=moi)) +
  geom_point(cex = 3) +
  ggtitle("Day 14: reproducibility of counts of non-essentials")

```



