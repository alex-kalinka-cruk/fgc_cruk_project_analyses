---
title: 'FGC_0005 Analysis'
author: "Alex Kalinka"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    depth: 3
    highlight: tango
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
---

# Setup

```{r,echo=F}
options(warn=-1)

suppressMessages(library(knitr))
suppressMessages(library(tidyr))
suppressMessages(library(magrittr))
suppressMessages(library(ggplot2))
suppressMessages(library(dplyr))
suppressMessages(library(perept))

filter <- dplyr::filter
select <- dplyr::select
rename <- dplyr::rename
mutate <- dplyr::mutate

# Slow to run from scratch.
desir_perf.depl <- readRDS(file="../data/desir_fdr_perf_depleted.rds")
mle_desir_0.8.depl <- readRDS(file="../data/mle_depleted_desir_thresh_0.8.rds")

# Data kept locally.
mageck_files <- list.files("~/data/az_cruk/cdc7", 
                           pattern = "Treatment_vs_Control.gene_summary.txt", recursive = T, full.names = T)

desir_files <- list.files("~/data/az_cruk/cdc7", 
                          pattern = "DesirabilityGeneRanking.tsv", recursive = T, full.names = T)

read_gene_summ <- function(files, type = "mageck"){
  ret <- NULL
  for(file in files){
    cell_line <- gsub("^.*?Comp-(\\S+?)\\/.*$","\\1",file)
    if(type == "mageck"){
      td <- read.table(file, header=T, stringsAsFactors = F) %>%
        select(id, neg.score, neg.p.value, neg.fdr, neg.rank, neg.lfc, pos.score, pos.p.value, pos.fdr, pos.rank, pos.lfc) %>%
        rename(gene = id)
    }else{
      td <- read.delim(file, header=T, stringsAsFactors = F) %>%
        select(gene, TvCCvP_PositiveDesi, TvCCvP_NegativeDesi, TvC_negpval, TvC_pospval, TvC_LFC)
    }
    ret <- rbind(ret, data.frame(cell_line = cell_line,td), stringsAsFactors=F)
  }
  return(ret)
}

data.mageck <- read_gene_summ(mageck_files)
data.desir <- read_gene_summ(desir_files, type = "desir")

```

# Approach



# Performance MLE: Choosing score cutoffs on basis of FPR estimates

## Desirability scores

```{r}
# Put data into format needed by 'MLE.perept'.
prep_4_mle <- function(data, desir_thresh, dcol_name = "TvCCvP_NegativeDesi"){
  dcol <- sym(dcol_name)
  data %<>%
      mutate(hit = !!dcol >= desir_thresh) %>%
      tidyr::pivot_wider(id_cols = c(cell_line, gene), names_from = cell_line, values_from = hit) %>%
      dplyr::rowwise() %>%
      mutate(total = sum(c(HCT116, `HT-29`, RKO, SW480))) %>%
      dplyr::ungroup() %>%
      filter(!is.na(total) & gene != "Control")
  return(data)
}

# Find desirability threshold that corresponds to FDR of X%.
fix_FDR.desir <- function(data, start_desir = 0.9, stop_desir = NULL, fdr_thresh = 0.1, type = "negative", step_size = 0.1){
  if(type == "negative"){
    data %<>%
      select(cell_line, gene, TvCCvP_NegativeDesi)
    dcol <- "TvCCvP_NegativeDesi"
  }else{
    data %<>%
      select(cell_line, gene, TvCCvP_PositiveDesi)
    dcol <- "TvCCvP_PositiveDesi"
  }
  desir_thresh <- start_desir
  finish <- FALSE
  track_perf <- NULL
  while(!finish){
    cat("Desirability Threshold:",desir_thresh,"\n")
    td <- prep_4_mle(data, desir_thresh, dcol_name = dcol)
    mle <- MLE.perept(as.data.frame(td))
    # Estimate of global FDR.
    num_TP <- mle$prevalence$theta_1*nrow(td)
    num_TN <- nrow(td)-num_TP
    num_FP <- mle$performance$p10*num_TN
    FDR <- num_FP/(num_FP+num_TP)
    # Estimate of FDR after excluding singletons.
    if(length(which(td$total>=2))==0){
      # No shared hits.
      FDR.comm <- 0
      prob_pos_2 <- 0
    }else{
      prob_two_false <- 1-mle$delta$delta_pos[which(td$total==2)[1]]
      prob_three_false <- 1-mle$delta$delta_pos[which(td$total==3)[1]]
      num_two_false <- round(length(which(td$total==2))*prob_two_false)
      num_three_false <- round(length(which(td$total==3))*prob_three_false)
      FDR.comm <- (num_two_false + num_three_false)/(length(which(td$total>=2)))
      prob_pos_2 <- mle$delta$delta_pos[which(td$total==2)[1]]
    }
    track_perf <- rbind(track_perf, data.frame(Desir_threshold = desir_thresh,
                                               FPR = mle$performance$p10,
                                               FDR.global = FDR,
                                               FDR.common = FDR.comm,
                                               Sensitivity = mle$performance$p11,
                                               Prevalence = round(mle$prevalence$theta_1*nrow(td)),
                                               Prob_pos.two_shared_hits = prob_pos_2,
                                               Number_singletons = length(which(td$total==1)),
                                               Number_common_hits = length(which(td$total>=2))))
    if(!is.null(stop_desir)){
      if(desir_thresh <= stop_desir){
        finish <- TRUE
        ret <- td %>%
        mutate(probability_hit = mle$delta$delta_pos)
      }
    }
    if(FDR.comm >= fdr_thresh){
      finish <- TRUE
      ret <- td %>%
        mutate(probability_hit = mle$delta$delta_pos)
    }else{
      desir_thresh <- desir_thresh - step_size
    }
  }
  return(list(data = ret, perf = track_perf))
}

```

### Depleted

```{r, eval=F}
fdr.desir <- fix_FDR.desir(data.desir)
fdr.desir.sp <- fix_FDR.desir(data.desir, start_desir = 0.8, step_size = 0.01)

```

```{r}
depl_candidates <-  prep_4_mle(data.desir,0.8) %>%
  mutate(probability_hit = mle_desir_0.8.depl$delta$delta_pos,
         gene_hit = probability_hit > 0.5)

# Singleton hits.
singleton_hits <- setdiff((data.mageck %>%
  filter(neg.fdr <= 0.1))$gene, depl_candidates$gene[depl_candidates$gene_hit])

```

```{r}
ggplot(desir_perf.depl, aes(Desir_threshold, FDR)) +
  geom_point() +
  geom_smooth()


```


### Enriched

```{r, eval=F}
fdr.desir.enr <- fix_FDR.desir(data.desir, type="positive")
fdr.desir.sp <- fix_FDR.desir(data.desir, type="positive", start_desir = 0.7, step_size = 0.02)


```



